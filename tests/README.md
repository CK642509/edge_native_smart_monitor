# Test Suite for Edge-Native Smart Monitor

This directory contains comprehensive tests for the Edge-Native Smart Monitor application.

## Test Structure

```
tests/
├── conftest.py              # Shared pytest fixtures
├── test_camera_stream.py    # Unit tests for CameraStream
├── test_ring_buffer.py      # Unit tests for RingBuffer
├── test_video_recorder.py   # Unit tests for VideoRecorder
├── test_detector.py         # Unit tests for Detector
├── test_monitor_system.py   # Integration tests for MonitorSystem
└── test_api.py              # API integration tests
```

## Running Tests

### Install Test Dependencies

```bash
pip install -r requirements.txt
```

This includes `pytest`, `pytest-asyncio`, and `httpx` for testing.

### Run All Tests

```bash
pytest tests/
```

### Run Specific Test Files

```bash
# Unit tests only
pytest tests/test_camera_stream.py tests/test_ring_buffer.py tests/test_detector.py tests/test_video_recorder.py

# Integration tests
pytest tests/test_monitor_system.py

# API tests
pytest tests/test_api.py
```

### Run Tests with Verbose Output

```bash
pytest tests/ -v
```

### Run Tests with Coverage

```bash
pytest tests/ --cov=app --cov-report=html
```

## Test Categories

### Unit Tests (36 tests)

- **CameraStream** (8 tests): Tests synthetic frame generation, lifecycle management, and frame iteration
- **RingBuffer** (10 tests): Tests thread safety, time-based eviction, and max frames eviction
- **VideoRecorder** (12 tests): Tests video file creation, retention policy, and error handling
- **Detector** (6 tests): Tests detector interface and detection events

### Integration Tests (14 tests)

- **MonitorSystem**: Tests the complete monitoring system lifecycle, frame capture, recording triggers, and status management

### API Tests (14 tests)

- **FastAPI Endpoints**: Tests all REST API endpoints including status, monitoring control, recording triggers, configuration updates, and MJPEG streaming

## Test Features

### Fixtures

The `conftest.py` file provides reusable fixtures:

- `temp_recording_dir`: Temporary directory for test recordings
- `test_config`: Test configuration with optimized settings
- `synthetic_camera`: Camera stream with forced synthetic mode
- `ring_buffer`: Pre-configured ring buffer
- `video_recorder`: Video recorder with temporary output
- `detector`: Basic detector instance
- `monitor_system`: Complete integrated system for testing

### Synthetic Frames

All tests use synthetic frames generated by `CameraStream` when no camera hardware is available. This ensures:

- Tests can run in CI/CD environments
- No hardware dependencies
- Consistent, reproducible test results
- Fast test execution

## Continuous Integration

These tests are designed to run in CI/CD pipelines without requiring camera hardware or special permissions. All components fall back to synthetic data when real hardware is unavailable.

## Test Coverage

The test suite covers:

- ✅ Camera stream initialization and synthetic frame generation
- ✅ Ring buffer thread safety and eviction policies
- ✅ Video recording and retention management
- ✅ Detector interface and event structures
- ✅ MonitorSystem lifecycle and frame processing
- ✅ Manual and automatic recording triggers
- ✅ API endpoints for monitoring control
- ✅ Configuration management via API
- ✅ Status reporting and state management
- ✅ MJPEG streaming endpoint
- ✅ Error handling and edge cases

## Total Test Count

**64 tests** covering all major components and integration points.
